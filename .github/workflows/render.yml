name: "Phorix Final Engine"
on:
  repository_dispatch:
    types: ["render_video"]

jobs:
  render:
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Setup Node"
        uses: "actions/setup-node@v4"
        with:
          node-version: 20

      - name: "Inject Assets & Code"
        id: inject
        shell: bash
        run: |
          set -e
          echo "ðŸ›  Cleaning workspace..."
          rm -rf src/*
          mkdir -p public/assets
          
          # Use GITHUB_EVENT_PATH for reliable payload extraction
          TSX_B64=$(jq -r '.client_payload.tsx_code_b64' "$GITHUB_EVENT_PATH")
          RAW_DURATION=$(jq -r '.client_payload.duration' "$GITHUB_EVENT_PATH")
          MEDIA_INPUTS=$(jq -r '.client_payload.media_inputs' "$GITHUB_EVENT_PATH")
          
          if [ "$TSX_B64" == "null" ] || [ -z "$TSX_B64" ]; then 
            echo "âŒ ERROR: TSX_B64 is EMPTY!"
            exit 1
          fi
          
          # 1. Decode TSX
          echo "ðŸ“„ Decoding TSX code..."
          echo "$TSX_B64" | base64 --decode > src/Component.tsx
          
          # 2. Handle Media Inputs
          if [ "$MEDIA_INPUTS" != "null" ] && [ ! -z "$MEDIA_INPUTS" ] && [ "$MEDIA_INPUTS" != "{}" ]; then
            echo "ðŸ“¥ Processing media inputs..."
            echo "$MEDIA_INPUTS" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              echo "Downloading $key..."
              curl -L "$value" -o "public/assets/$key" --fail --silent || echo "âš ï¸ Failed to download $key"
            done
          fi
          
          # 3. Set Duration
          FINAL_DURATION=${RAW_DURATION:-450}
          if [ "$FINAL_DURATION" == "null" ]; then FINAL_DURATION=450; fi
          echo "duration=$FINAL_DURATION" >> $GITHUB_OUTPUT
          
          # 4. Generate index.tsx with placeholder for asset mapping
          cat <<'EOF' > src/index.tsx
          import { registerRoot, Composition, staticFile } from 'remotion';
          import React from 'react';
          import * as Comp from './Component';
          
          const RemotionRoot: React.FC = () => {
            const Target = Comp.HelloWorld;
            if (!Target) throw new Error("HelloWorld export missing from payload!");
            
            const assets: Record<string, string> = {};
            // ASSET_MAP_PLACEHOLDER
            
            return (
              <Composition 
                id="Phorix" 
                component={Target as any} 
                durationInFrames={DURATION_PLACEHOLDER} 
                fps={30} 
                width={1920} 
                height={1080}
                defaultProps={{ assets }}
              />
            );
          };
          registerRoot(RemotionRoot);
          export default RemotionRoot;
          EOF

          # Use a safer replacement for DURATION_PLACEHOLDER
          sed -i "s/DURATION_PLACEHOLDER/$FINAL_DURATION/g" src/index.tsx
          
          # Use a Python script for safe code injection (to avoid sed delimiter issues)
          if [ "$MEDIA_INPUTS" != "null" ] && [ ! -z "$MEDIA_INPUTS" ] && [ "$MEDIA_INPUTS" != "{}" ]; then
            python3 -c "
            import json, sys
            media = json.loads(sys.argv[1])
            js_lines = [f'assets[\"{k}\"] = \"assets/{k}\";' for k in media.keys()]
            js_code = '\\n  '.join(js_lines)
            with open('src/index.tsx', 'r') as f:
                content = f.read()
            content = content.replace('// ASSET_MAP_PLACEHOLDER', js_code)
            with open('src/index.tsx', 'w') as f:
                f.write(content)
            " "$MEDIA_INPUTS"
          fi

      - name: "Install Dependencies"
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg libnss3 libatk-bridge2.0-0 libcups2 libdbus-1-3 libdrm2 libgbm1 libasound2t64 jq
          npm install --no-package-lock

      - name: "Render Video"
        id: render
        run: |
          npx remotion render src/index.tsx Phorix out/video.mp4 --overwrite --bundle-cache=false

      - name: "Deliver Video"
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -v -F "video=@out/video.mp4" -F "chat_id=$TG_CHAT_ID" -F "caption=âœ… *Phorix Render Success!*%0ADuration: ${{ steps.inject.outputs.duration }} frames" -F "parse_mode=Markdown" https://api.telegram.org/bot$TG_TOKEN/sendVideo

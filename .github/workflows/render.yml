name: "Phorix Final Engine"
on:
  repository_dispatch:
    types: ["render_video"]

jobs:
  render:
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Telegram: Render Started"
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d "chat_id=$TG_CHAT_ID" \
            -d "text=üé¨ *Render Started*%0A- Repository: Remotion-Experiment%0A- Event: ${{ github.event.action }}" \
            -d "parse_mode=Markdown"

      - name: "Setup Node"
        uses: "actions/setup-node@v4"
        with:
          node-version: 20

      - name: "Inject Assets & Code"
        id: inject
        shell: bash
        env:
          TSX_B64: ${{ github.event.client_payload.tsx_code_b64 }}
          RAW_DURATION: ${{ github.event.client_payload.duration }}
          MEDIA_INPUTS: ${{ github.event.client_payload.media_inputs }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          set -e
          echo "üõ† Cleaning workspace..."
          rm -rf src/*
          mkdir -p public/assets
          
          if [ -z "$TSX_B64" ]; then 
            echo "‚ùå ERROR: TSX_B64 is EMPTY!"
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CHAT_ID" -d "text=‚ùå *Error*: TSX code is missing!" -d "parse_mode=Markdown"
            exit 1
          fi
          
          # 1. Decode TSX
          echo "üìÑ Decoding TSX code..."
          echo "$TSX_B64" | base64 --decode > src/Component.tsx
          
          # 2. Handle Media Inputs
          if [ ! -z "$MEDIA_INPUTS" ] && [ "$MEDIA_INPUTS" != "{}" ]; then
            echo "üì• Processing media inputs..."
            echo "$MEDIA_INPUTS" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r key value; do
              echo "Downloading $key..."
              if ! curl -L "$value" -o "public/assets/$key" --fail --silent; then
                echo "‚ùå Failed to download $key"
                curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CHAT_ID" -d "text=‚ö†Ô∏è *Warning*: Failed to download asset: $key" -d "parse_mode=Markdown"
              fi
            done
          fi
          
          # 3. Set Duration
          FINAL_DURATION=${RAW_DURATION:-450}
          echo "duration=$FINAL_DURATION" >> $GITHUB_OUTPUT
          
          # 4. Generate index.tsx
          cat <<'EOF' > src/index.tsx
          import { registerRoot, Composition, staticFile } from 'remotion';
          import React from 'react';
          import * as Comp from './Component';
          
          const RemotionRoot: React.FC = () => {
            const Target = Comp.HelloWorld;
            if (!Target) throw new Error("HelloWorld export missing from payload!");
            
            const assets: Record<string, string> = {};
            // ASSET_MAP_PLACEHOLDER
            
            return (
              <Composition 
                id="Phorix" 
                component={Target as any} 
                durationInFrames={DURATION_PLACEHOLDER} 
                fps={30} 
                width={1920} 
                height={1080}
                defaultProps={{ assets }}
              />
            );
          };
          registerRoot(RemotionRoot);
          export default RemotionRoot;
          EOF

          sed -i "s/DURATION_PLACEHOLDER/$FINAL_DURATION/" src/index.tsx
          
          if [ ! -z "$MEDIA_INPUTS" ] && [ "$MEDIA_INPUTS" != "{}" ]; then
            ASSET_MAP_JS=$(echo "$MEDIA_INPUTS" | jq -r 'to_entries | map("assets[\"\(.key)\"] = \"assets/\( .key)\";") | .[]')
            # Escape newlines for sed
            ASSET_MAP_JS_ESCAPED=$(echo "$ASSET_MAP_JS" | sed ':a;N;$!ba;s/\n/\\n/g')
            sed -i "s/\/\/ ASSET_MAP_PLACEHOLDER/$ASSET_MAP_JS_ESCAPED/" src/index.tsx
          fi

      - name: "Install Dependencies"
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CHAT_ID" -d "text=üì¶ *Installing Dependencies*..." -d "parse_mode=Markdown"
          sudo apt-get update && sudo apt-get install -y ffmpeg libnss3 libatk-bridge2.0-0 libcups2 libdbus-1-3 libdrm2 libgbm1 libasound2t64 jq
          npm install --no-package-lock

      - name: "Render Video"
        id: render
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CHAT_ID" -d "text=üé• *Rendering Video* (${{ steps.inject.outputs.duration }} frames)..." -d "parse_mode=Markdown"
          if ! npx remotion render src/index.tsx Phorix out/video.mp4 --overwrite --bundle-cache=false; then
             echo "‚ùå Render Failed"
             curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CHAT_ID" -d "text=‚ùå *Render Failed*! Check GitHub Action logs." -d "parse_mode=Markdown"
             exit 1
          fi

      - name: "Deliver Video"
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -v -F "video=@out/video.mp4" -F "chat_id=$TG_CHAT_ID" -F "caption=‚úÖ *Phorix Render Success!*%0ADuration: ${{ steps.inject.outputs.duration }} frames" -F "parse_mode=Markdown" https://api.telegram.org/bot$TG_TOKEN/sendVideo

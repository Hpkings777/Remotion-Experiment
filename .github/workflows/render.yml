name: Phorix Dynamic Render Engine
on:
  repository_dispatch:
    types: [render_video]

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # Cache hata diya hai taaki lock-file ka error na aaye

      - name: Inject Dynamic Code
        shell: bash
        env:
          DYNAMIC_CODE: ${{ github.event.client_payload.tsx_code }}
        run: |
          # Single quotes 'EOF' interpolation rokne ke liye
          cat <<'EOF' > src/Composition.tsx
          ${{ github.event.client_payload.tsx_code }}
          EOF

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          PACKAGES="ffmpeg libnss3 libatk-bridge2.0-0 libcups2 libdbus-1-3 libdrm2 libgbm1"
          # Try to install libasound2 if available, otherwise fall back to libasound2t64 (recent runners)
          if apt-cache show libasound2 >/dev/null 2>&1; then
            sudo apt-get install -y --no-install-recommends $PACKAGES libasound2
          else
            sudo apt-get install -y --no-install-recommends $PACKAGES libasound2t64
          fi

      - name: Force Install NPM Dependencies
        run: |
          # Lock file ki tension khatam
          npm install --no-package-lock

      - name: Render Video
        run: |
          # HelloWorld ID template-helloworld ka default hai
          npx remotion render HelloWorld out/video.mp4

      - name: Deliver to Telegram
        if: success()
        run: |
          curl -v -F "video=@out/video.mp4" \
          -F "chat_id=${{ secrets.TG_CHAT_ID }}" \
          -F "caption=üöÄ Hapa-hap Render Complete! Phorix is now Live." \
          https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendVideo

      - name: Notify Failure
        if: failure()
        run: |
          curl -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d text="‚ùå Bhai, Render fail ho gaya. GitHub Actions logs check kar!"